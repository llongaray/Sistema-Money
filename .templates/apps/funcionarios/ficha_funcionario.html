{% extends 'base.html' %}
{% load static %}

{% block addtitle %}
<title>Ficha do Funcionário</title>
{% endblock %}

{% block addcss_extra %}
<link rel="stylesheet" href="{% static 'funcionarios/all_forms.css' %}">
<link rel="stylesheet" href="{% static 'modais.css' %}">
<link rel="stylesheet" href="{% static 'divider.css' %}">
<link rel="stylesheet" href="{% static 'geral_forms.css' %}">
<link rel="stylesheet" href="{% static 'mensagens.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    .password-field {
        position: relative;
        display: flex;
        align-items: center;
    }

    .password-field input {
        flex: 1;
        padding-right: 35px; /* Espaço para o ícone */
    }

    .toggle-password {
        position: absolute;
        right: 10px;
        cursor: pointer;
        color: #666;
        transition: color 0.3s ease;
    }

    .toggle-password:hover {
        color: #333;
    }

    .password-field input, .password-field .toggle-password {
        margin: 0;
    }
</style>


{% endblock %}

{% block pre_content %}
{% include 'partials/_dark_mode_toggle.html' %}
{% include 'partials/_messages.html' %}
{% endblock %}

{% block content %}

<div class="container">
    <!-- Botões para abrir os modais -->
    <div class="options_modais">
        <button type="button" class="btn btn-primary" onclick="abrirModalOptions('#modalEditarFuncionario')">
            Editar Funcionário
        </button>
        <button type="button" class="btn btn-primary" onclick="abrirModalOptions('#modalEditarUsuario')">
            Editar Usuário
        </button>
    </div>

    <div class="divider"></div>


    <!-- Modal para Editar Funcionário -->
    <div class="modal active" id="modalEditarFuncionario">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Funcionário</h5>
                    <button type="button" class="btn-close" onclick="fecharModal('modalEditarFuncionario')"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" enctype="multipart/form-data" action="{% url 'funcionarios:update_funcionario' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="update_funcionario">
                        <input type="hidden" name="funcionario_id" value="{{ funcionario.id }}">
                        
                        <section>
                            <h3>Informações Básicas</h3>
                            <div class="section-content">
                                <div class="section-left">
                                    <div class="form-group">
                                        {{ form_funcionario.nome.label_tag }}
                                        {{ form_funcionario.nome }}
                                    </div>
                                    <div class="form-group">
                                        {{ form_funcionario.sobrenome.label_tag }}
                                        {{ form_funcionario.sobrenome }}
                                    </div>
                                    <div class="form-group">
                                        {{ form_funcionario.cpf.label_tag }}
                                        {{ form_funcionario.cpf }}
                                    </div>
                                </div>
                                <div class="section-right">
                                    <div class="form-group">
                                        <label>Foto atual</label>
                                        {% if funcionario.foto %}
                                            <img src="{{ funcionario.foto.url }}" alt="Foto do funcionário" class="foto-preview">
                                        {% else %}
                                            <p>Nenhuma foto cadastrada</p>
                                        {% endif %}
                                    </div>
                                    <div class="form-group">
                                        <label for="id_foto">Atualizar foto:</label>
                                        <input type="file" name="foto" id="id_foto" class="form-control-file">
                                    </div>
                                    <div class="status-container">
                                        <span>Status:</span>
                                        <div class="toggleWrapper">
                                            <input type="checkbox" name="status" class="mobileToggle" id="toggle_status" {% if funcionario.status == 'Ativo' %}checked{% endif %}>
                                            <label for="toggle_status"></label>
                                        </div>
                                        <span id="status_text">{% if funcionario.status == 'Ativo' %}Ativo{% else %}Inativo{% endif %}</span>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <section>
                            <h3>Dados Pessoais</h3>
                            <div class="form-group">
                                {{ form_funcionario.data_de_nascimento.label_tag }}
                                {{ form_funcionario.data_de_nascimento }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.genero.label_tag }}
                                {{ form_funcionario.genero }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.estado_civil.label_tag }}
                                {{ form_funcionario.estado_civil }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.nacionalidade.label_tag }}
                                {{ form_funcionario.nacionalidade }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.naturalidade.label_tag }}
                                {{ form_funcionario.naturalidade }}
                            </div>
                        </section>

                        <section>
                            <h3>Informações Familiares</h3>
                            <div class="form-group">
                                {{ form_funcionario.nome_do_pai.label_tag }}
                                {{ form_funcionario.nome_do_pai }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.nome_da_mae.label_tag }}
                                {{ form_funcionario.nome_da_mae }}
                            </div>
                        </section>

                        <section>
                            <h3>Endereço</h3>
                            <div class="form-group">
                                {{ form_funcionario.cep.label_tag }}
                                {{ form_funcionario.cep }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.endereco.label_tag }}
                                {{ form_funcionario.endereco }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.bairro.label_tag }}
                                {{ form_funcionario.bairro }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.cidade.label_tag }}
                                {{ form_funcionario.cidade }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.estado.label_tag }}
                                {{ form_funcionario.estado }}
                            </div>
                        </section>

                        <section>
                            <h3>Contato</h3>
                            <div class="form-group">
                                {{ form_funcionario.celular.label_tag }}
                                {{ form_funcionario.celular }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.celular_sms.label_tag }}
                                {{ form_funcionario.celular_sms }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.celular_ligacao.label_tag }}
                                {{ form_funcionario.celular_ligacao }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.celular_whatsapp.label_tag }}
                                {{ form_funcionario.celular_whatsapp }}
                            </div>
                        </section>

                        <section>
                            <h3>Documentos</h3>
                            <div class="form-group">
                                {{ form_funcionario.rg.label_tag }}
                                {{ form_funcionario.rg }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.cnpj.label_tag }}
                                {{ form_funcionario.cnpj }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.pis.label_tag }}
                                {{ form_funcionario.pis }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.cnh.label_tag }}
                                {{ form_funcionario.cnh }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.categoria_cnh.label_tag }}
                                {{ form_funcionario.categoria_cnh }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.ctps.label_tag }}
                                {{ form_funcionario.ctps }}
                            </div>
                        </section>

                        <section>
                            <h3>Informações Profissionais</h3>
                            <div class="form-group">
                                {{ form_funcionario.matricula.label_tag }}
                                {{ form_funcionario.matricula }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.empresa.label_tag }}
                                {{ form_funcionario.empresa }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.loja.label_tag }}
                                {{ form_funcionario.loja }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.data_de_admissao.label_tag }}
                                {{ form_funcionario.data_de_admissao }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.horario.label_tag }}
                                {{ form_funcionario.horario }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.departamento.label_tag }}
                                {{ form_funcionario.departamento }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.cargo.label_tag }}
                                {{ form_funcionario.cargo }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.numero_da_folha.label_tag }}
                                {{ form_funcionario.numero_da_folha }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.superior_direto.label_tag }}
                                {{ form_funcionario.superior_direto }}
                            </div>
                        </section>

                        <section>
                            <h3>Arquivos</h3>
                            <div class="form-group">
                                {{ form_funcionario.identidade.label_tag }}
                                {{ form_funcionario.identidade }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.carteira_de_trabalho.label_tag }}
                                {{ form_funcionario.carteira_de_trabalho }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.comprovante_de_escolaridade.label_tag }}
                                {{ form_funcionario.comprovante_de_escolaridade }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.pdf_contrato.label_tag }}
                                {{ form_funcionario.pdf_contrato }}
                            </div>
                            <div class="form-group">
                                {{ form_funcionario.certidao_de_nascimento.label_tag }}
                                {{ form_funcionario.certidao_de_nascimento }}
                            </div>
                        </section>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" name="update_funcionario">Atualizar Funcionário</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Usuário -->
    <div class="modal" id="modalEditarUsuario">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Usuário</h5>
                    <button type="button" class="btn-close" onclick="fecharModal('modalEditarUsuario')"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'funcionarios:update_user' %}">
                        {% csrf_token %}
                        <input type="hidden" name="form_type" value="update_user">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
    
                        <!-- Substitua {{ form_user.as_p }} pelos campos individuais -->
                        {% for field in form_user %}
                            <div class="form-group">
                                {{ field.label_tag }}
                                {% if 'password' in field.name %}
                                    <div class="password-field">
                                        {{ field }}
                                        <i class="fas fa-eye-slash toggle-password" onclick="togglePasswordVisibility(this)"></i>
                                    </div>
                                {% else %}
                                    {{ field }}
                                {% endif %}
                            </div>
                        {% endfor %}
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary" name="update_user">Atualizar Usuário</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block addjs_extra %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'darkmode.js' %}"></script>
<script src="{% static 'modais.js' %}"></script>
<script src="{% static 'geral_forms.js' %}"></script>
<script src="{% static 'mensagem.js' %}"></script>

<script>
    function togglePasswordVisibility(icon) {
        console.log('Função togglePasswordVisibility chamada', icon);
        // Alteração aqui: procurar o input dentro do password-field
        const input = icon.parentElement.querySelector('input');
        console.log('Input encontrado:', input);
        
        if (input.type === 'password') {
            console.log('Alterando tipo de password para text');
            input.type = 'text';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        } else {
            console.log('Alterando tipo de text para password');
            input.type = 'password';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded iniciado');
        
        // Procurar campos de senha
        const passwordFields = document.querySelectorAll('input[type="password"]');
        console.log('Campos de senha encontrados:', passwordFields.length);

        // Adiciona os ícones de olho aos campos de senha
        passwordFields.forEach((input, index) => {
            console.log(`Processando campo de senha ${index + 1}:`, input);
            
            // Criar wrapper apenas se o input ainda não estiver em um
            if (!input.parentElement.classList.contains('password-field')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'password-field';
                console.log('Wrapper criado:', wrapper);

                // Verificar o pai do input antes de inserir
                console.log('Pai do input antes:', input.parentNode);
                input.parentNode.insertBefore(wrapper, input);
                wrapper.appendChild(input);
                console.log('Input movido para o wrapper');
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-eye-slash toggle-password';
                icon.onclick = function() { 
                    console.log('Ícone clicado');
                    togglePasswordVisibility(this); 
                };
                wrapper.appendChild(icon);
                console.log('Ícone adicionado ao wrapper');
            }
        });

        // Restaurar estado do modal se necessário
        console.log('Restaurando estado do modal');
        restoreActiveModalState();

        // Adicionar listeners para os botões de fechar modal
        const closeButtons = document.querySelectorAll('.btn-close');
        console.log('Botões de fechar encontrados:', closeButtons.length);
        
        closeButtons.forEach(button => {
            button.addEventListener('click', function() {
                const modalId = this.closest('.modal').id;
                console.log('Fechando modal:', modalId);
                fecharModal(modalId);
            });
        });

        console.log('DOMContentLoaded finalizado');
    });

    document.addEventListener('DOMContentLoaded', function() {
        const empresaSelect = document.querySelector('#id_empresa');
        const lojaSelect = document.querySelector('#id_loja');

        if (empresaSelect && lojaSelect) {
            empresaSelect.addEventListener('change', function() {
                const empresaId = this.value;
                lojaSelect.innerHTML = '<option value="">Selecione uma loja</option>';
                
                if (empresaId) {
                    fetch(`/api/lojas/${empresaId}/`)
                        .then(response => response.json())
                        .then(lojas => {
                            lojas.forEach(loja => {
                                const option = new Option(loja.nome, loja.id);
                                lojaSelect.add(option);
                            });
                        });
                }
            });
        }
    });
</script>
{% endblock %}



